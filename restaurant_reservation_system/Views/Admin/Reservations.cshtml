@using restaurant_reservation.Models
@using restaurant_reservation_system.Models.Dto
@using restaurant_reservation_system.Models.ViewModel
@{
    ViewData["Title"] = "Reservations";
    int userIndex = 1;
    int guestIndex = 1;
}

@model AdminReservationsViewModel

<div class="container mt-4">
    <h2 class="text-center mb-4">User And Guest Reservations</h2>

    <div class="mb-4">
        <select id="statusFilter" class="form-select w-auto">
            <option value="all">All Reservations</option>
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Outdated">Outdated</option>
        </select>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var userReservation in Model.UserReservations)
        {
            <div class="col" data-reservation>
                <div class="card user-reservation-card h-100" data-status="@userReservation.Status">
                    <div class="card-header text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            @if (userReservation.Status == ReservationStatus.Confirmed.ToString())
                            {
                                <span class="badge bg-success">@userReservation.Status</span>
                            }
                            else if (userReservation.Status == ReservationStatus.Pending.ToString())
                            {
                                <span class="badge bg-warning">@userReservation.Status</span>
                            }
                            else if (userReservation.Status == ReservationStatus.Outdated.ToString())
                            {
                                <span class="badge bg-danger">@userReservation.Status</span>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">User Reservation #@userIndex</h5>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.CustomerName</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.CustomerEmail</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.CustomerPhone</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.ReservationDateLocal.ToShortDateString()</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.ReservationHour:00</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@userReservation.NumberOfGuests guests</span>
                        </div>
                        <div class="text-muted small">
                            <span class="ms-2">Created: @userReservation.CreatedAtLocal.ToShortDateString() @userReservation.CreatedAtLocal.ToShortTimeString()</span>
                        </div>
                        <br />
                        <form asp-controller="Admin" asp-action="DeleteUserReservation" method="post" style="display: inline;" id="deleteForm_@userReservation.Id">
                            <input type="hidden" name="id" value="@userReservation.Id" />
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="showDeleteModal(@userReservation.Id)">Delete</button>
                        </form>
                        @if (userReservation.Status == "Pending")
                        {
                            <form asp-controller="Admin" asp-action="UpdateUserReservationStatus" method="post" style="display: inline;" id="confirmForm_@userReservation.Id">
                                <input type="hidden" name="id" value="@userReservation.Id" />
                                <input type="hidden" name="status" value="Confirmed" />
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="showConfirmModal(@userReservation.Id)">Confirm</button>
                            </form>
                        }
                        else if (userReservation.Status == "Confirmed")
                        {
                            <form asp-controller="Admin" asp-action="UpdateUserReservationStatus" method="post" style="display: inline;" id="cancelForm_@userReservation.Id">
                                <input type="hidden" name="id" value="@userReservation.Id" />
                                <input type="hidden" name="status" value="Pending" />
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="showCancelConfirmationModal(@userReservation.Id)">Cancel</button>
                            </form>
                        }
                    </div>
                </div>
            </div>
            userIndex++;
        }

        @foreach (var guestReservation in Model.GuestReservations)
        {
            <div class="col" data-reservation>
                <div class="card guest-reservation-card h-100" data-status="@guestReservation.Status">
                    <div class="card-header text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            @if (guestReservation.Status == ReservationStatus.Confirmed.ToString())
                            {
                                <span class="badge bg-success">@guestReservation.Status</span>
                            }
                            else if (guestReservation.Status == ReservationStatus.Pending.ToString())
                            {
                                <span class="badge bg-warning">@guestReservation.Status</span>
                            }
                            else if (guestReservation.Status == ReservationStatus.Outdated.ToString())
                            {
                                <span class="badge bg-danger">@guestReservation.Status</span>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Guest Reservation #@guestIndex</h5>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.FullName</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.Email</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.PhoneNumber</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.ReservationDateLocal.ToShortDateString()</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.ReservationDateLocal.ToShortTimeString()</span>
                        </div>
                        <div class="mb-3">
                            <span class="ms-2">@guestReservation.NumberOfGuests guests</span>
                        </div>
                        <div class="text-muted small">
                            <span class="ms-2">Created: @guestReservation.CreatedAtLocal.ToShortDateString() @guestReservation.CreatedAtLocal.ToShortTimeString()</span>
                        </div>
                        <br />
                        <form asp-controller="Admin" asp-action="DeleteGuestReservation" method="post" style="display: inline;" id="deleteForm_@guestReservation.Id">
                            <input type="hidden" name="id" value="@guestReservation.Id" />
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="showDeleteModal(@guestReservation.Id)">Delete</button>
                        </form>
                        @if (guestReservation.Status == "Pending")
                        {
                            <form asp-controller="Admin" asp-action="UpdateGuestReservationStatus" method="post" style="display: inline;" id="confirmForm_@guestReservation.Id">
                                <input type="hidden" name="id" value="@guestReservation.Id" />
                                <input type="hidden" name="status" value="Confirmed" />
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="showConfirmModal(@guestReservation.Id)">Confirm</button>
                            </form>
                        }
                        else if (guestReservation.Status == "Confirmed")
                        {
                            <form asp-controller="Admin" asp-action="UpdateGuestReservationStatus" method="post" style="display: inline;" id="cancelForm_@guestReservation.Id">
                                <input type="hidden" name="id" value="@guestReservation.Id" />
                                <input type="hidden" name="status" value="Pending" />
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="showCancelConfirmationModal(@guestReservation.Id)">Cancel</button>
                            </form>
                        }
                    </div>
                </div>
            </div>
            guestIndex++;
        }
    </div>

    <partial name="_DeleteConfirmationModal" />
</div>

@section Scripts {
    <script>
        function showDeleteModal(reservationId) {
            var modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            document.getElementById('confirmDeleteBtn').onclick = function () {
                document.getElementById('deleteForm_' + reservationId).submit();
            };
            modal.show();
        }

        function showConfirmModal(reservationId) {
            var modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            document.getElementById('confirmDeleteBtn').onclick = function () {
                document.getElementById('confirmForm_' + reservationId).submit();
            };
            modal.show();
        }

        function showCancelConfirmationModal(reservationId) {
            var modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            document.getElementById('confirmDeleteBtn').onclick = function () {
                document.getElementById('cancelForm_' + reservationId).submit();
            };
            modal.show();
        }

        document.getElementById('statusFilter').addEventListener('change', function() {
            var selectedStatus = this.value;
            var reservationCards = document.querySelectorAll('[data-reservation]');
            reservationCards.forEach(function(card) {
                var cardStatus = card.querySelector('.card').getAttribute('data-status');
                if (selectedStatus === 'all' || cardStatus === selectedStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    </script>
}